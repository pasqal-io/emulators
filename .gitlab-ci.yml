workflow:
  rules:
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED != "true"
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG
      variables:
        PROTECT: "protected"
    - if: $CI_COMMIT_REF_PROTECTED == "true"
      variables:
        PROTECT: "protected"
    - if: $CI_PIPELINE_SOURCE == "web"

.default_rules:
  rules:
    #don't run if were the scheduled pipeline that defines the below variable
    - if: $PARENT_PIPELINE_SOURCE == "schedule"
      when: never
    # Run when an MR is created/updated
    - if: $PARENT_PIPELINE_SOURCE == "merge_request_event"
    # Otherwise, we're a commit, but if an open MR exists, don't run
    - if: $PARENT_COMMIT_BRANCH && $PARENT_OPEN_MR
      when: never
    # Don't run on releases
    - if: $PARENT_COMMIT_TAG
      when: never
    - if: $PARENT_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH

.test:
  script:
    - pip install -r test_requirements.txt
    - pip install -e .
    - pytest -vvv --cov-report=term-missing --cov-config=pyproject.toml --cov=emu_mps --cov=emu_base
    - pytest --nbmake **/*ipynb
    - readme-cov
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'


stages:
  - lint
  - test
  - ci
  - pages

lint:
  extends:
    - .default_rules
  image: python:3.10
  stage: lint
  script:
    - pip install pre-commit pyproject-flake8
    - pre-commit install
    - pre-commit run --all-files

test-py3.10:
  extends:
    - .default_rules
    - ".test"
  image: python:3.10
  stage: test

emu_base_ci:
  stage: ci
  trigger:
    strategy: depend
    include:
      - local: ci/emu_base/.gitlab-ci.yml
  variables:
    PARENT_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
    PARENT_COMMIT_BRANCH: $CI_COMMIT_BRANCH
    PARENT_OPEN_MR: $CI_OPEN_MERGE_REQUESTS
    PARENT_COMMIT_REF_PROTECTED: $CI_COMMIT_REF_PROTECTED
    PARENT_COMMIT_TAG: $CI_COMMIT_TAG
    PARENT_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME
    PARENT_TRIGGER_SOURCE: $CI_PIPELINE_TRIGGER_SOURCE

emu_mps_ci:
  stage: ci
  needs:
    - emu_base_ci
  trigger:
    strategy: depend
    include:
      - local: ci/emu_mps/.gitlab-ci.yml
  variables:
    PARENT_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
    PARENT_COMMIT_BRANCH: $CI_COMMIT_BRANCH
    PARENT_OPEN_MR: $CI_OPEN_MERGE_REQUESTS
    PARENT_COMMIT_REF_PROTECTED: $CI_COMMIT_REF_PROTECTED
    PARENT_COMMIT_TAG: $CI_COMMIT_TAG
    PARENT_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME
    PARENT_TRIGGER_SOURCE: $CI_PIPELINE_TRIGGER_SOURCE

pages:
  stage: pages
  image: python:3.10
  artifacts:
    paths:
      - public
  rules:
    - if: $PARENT_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    - pip install -r doc_requirements.txt
    - pip install -e .
    - mkdocs build --clean --strict --site-dir public
